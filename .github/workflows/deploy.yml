name: Build & Deploy to AKS

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write            # necessario per OIDC (se lo usi)
  packages: write            # per Docker login
  actions: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # qui metti IMAGE in env, così vale in tutti i passi
    env:
      IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/moodtrack-api:${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 -t $IMAGE .

      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Push to ACR
        run: docker push $IMAGE

      # …
      - name: Rolling update Deployment
        run: |
          kubectl set image deployment/moodtrack-api \
            api=$IMAGE \
            -n moodtrack
          kubectl rollout status deployment/moodtrack-api -n moodtrack --timeout=500s